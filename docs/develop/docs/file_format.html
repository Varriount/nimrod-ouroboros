<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nimrod. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Nimrod Ouroboros appended data file format</title>
<style type="text/css">

span.DecNumber {color: blue}
span.BinNumber {color: blue}
span.HexNumber {color: blue}
span.OctNumber {color: blue}
span.FloatNumber {color: blue}
span.Identifier  {color: black}
span.Keyword {font-weight: bold}
span.StringLit {color: blue}
span.LongStringLit {color: blue}
span.CharLit {color: blue}
span.EscapeSequence {color: black}
span.Operator {color: black}
span.Punctuation {color: black}
span.Comment, span.LongComment {font-style:italic; color: green}
span.RegularExpression  {color: DarkViolet}
span.TagStart {color: DarkViolet}
span.TagEnd {color: DarkViolet}
span.Key  {color: blue}
span.Value  {color: black}
span.RawData {color: blue}
span.Assembler  {color: blue}
span.Preprocessor {color: DarkViolet}
span.Directive  {color: DarkViolet}
span.Command, span.Rule, span.Hyperlink, span.Label, span.Reference, 
span.Other  {color: black}

div.navigation {
  -moz-border-radius: 5px 5px 5px 5px;
  float: left; 
  width: 30%;
  margin: 0; padding: 0;
  border: 3px outset #7F7F7F;
  background-color: #7F7F7F;
}

div.navigation ul {
  list-style-type: none;
  padding-left: 1em;
}
div.navigation ul li a, div.navigation ul li a:visited {
  font-weight: bold;
  color: #FFFFFF;
  text-decoration: none;
}
div.navigation ul li a:hover {
  font-weight: bold;
  text-decoration: none;
  color: gold;
}

div.content {
  margin-left: 30%;
  padding: 0 1em;
  border-left: 4em;
}

dl.item dd, dl.item dd p {
  margin-top:3px;
}
dl.item dd pre {
  margin-left: 15pt;
  border: 0px;
}
dl.item dt, dl.item dt pre {
  margin:  20pt 0 0 5pt;
}

pre, span.tok {
  background-color: #F9F9F9;
  border-color: #C4C4C4;
  border-style: solid;
  border-width: 1px 1px 1px 2px;
  color: black;
  line-spacing: 110%;
  padding: 2px;
}

span.red {
  color: #A80000;
}

hr {background-color:#9D9D9D; border:0 none; color:#9D9D9D; height:1px; width:100%;}

/*
:Author: David Goodger
:Contact: goodger@python.org
:Date: Date: 2006-05-21 22:44:42 +0200 (Sun, 21 May 2006)
:Revision: Revision: 4564
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/
/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th { border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first { margin-top: 0 ! important }
.last, .with-subtitle { margin-bottom: 0 ! important }
.hidden { display: none }
a.toc-backref { text-decoration: none ; color: black }
blockquote.epigraph { margin: 2em 5em ; }
dl.docutils dd { margin-bottom: 0.5em }
div.abstract { margin: 2em 5em }
div.abstract p.topic-title { font-weight: bold ; text-align: center }
div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ; border: medium outset ; padding: 1em }
div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title { font-weight: bold ; font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title { color: red ; font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication { margin: 2em 5em ; text-align: center ; font-style: italic }
div.dedication p.topic-title { font-weight: bold ; font-style: normal }
div.figure { margin-left: 2em ; margin-right: 2em }
div.footer, div.header { clear: both; font-size: smaller }
div.line-block { display: block ; margin-top: 1em ; margin-bottom: 1em }
div.line-block div.line-block { margin-top: 0 ; margin-bottom: 0 ;
  margin-left: 1.5em }
div.sidebar { margin-left: 1em ; border: medium outset ;
  padding: 1em ; background-color: #ffffee ; /*width: 40% ;*/ float: right ;
  clear: right }

div.sidebar p.rubric { font-family: sans-serif ; font-size: medium }
div.system-messages { margin: 5em }
div.system-messages h1 { color: red }
div.system-message { border: medium outset ; padding: 1em }
div.system-message p.system-message-title { color: red ; font-weight: bold }
div.topic { margin: 2em;}
h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }
h1.title { text-align: center }
h2.subtitle { text-align: center }
/* hr.docutils { width: 75% } */
img.align-left { clear: left }
img.align-right { clear: right }
ol.simple, ul.simple { margin-bottom: 1em }
ol.arabic { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }
p.attribution { text-align: right ; margin-left: 50% }
p.caption { font-style: italic }
p.credits { font-style: italic ; font-size: smaller }
p.label { white-space: nowrap }
p.rubric { font-weight:bold;font-size:larger;color:maroon;text-align:center}
p.sidebar-title {font-family: sans-serif ;font-weight: bold ;font-size: larger }
p.sidebar-subtitle {font-family: sans-serif ; font-weight: bold }
p.topic-title {
font-weight: bold;
background-color: #6D6D6D;
border-bottom: 1px solid #000000;
border-top: 1px solid black;
color: white;
text-align: center;
margin: 0;
}
pre.address { margin-bottom: 0;margin-top:0;font-family:serif;font-size:100% }
pre.literal-block, pre.doctest-block {margin-left: 2em ;margin-right: 2em }
span.classifier {font-family: sans-serif;font-style: oblique }
span.classifier-delimiter {font-family: sans-serif;font-weight: bold }
span.interpreted {font-family: sans-serif }
span.option {white-space: nowrap }
span.pre {white-space: pre }
span.problematic {color: red }
span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation { border-left: solid 1px gray; margin-left: 1px }
table.docinfo {margin: 2em 4em }
table.docutils {margin-top: 0.5em;margin-bottom: 0.5em; border: 0 solid #9d9d9d; border-collapse: collapse; }
table.footnote {border-left: solid 1px black;margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {padding-left: 0.5em;padding-right: 0.5em;
  vertical-align: top;}

table.docutils td, table.docutils th { border-bottom:1px solid #9D9D9D; }
/* color: #4d4d4d} */

/* table.docutils td:hover, table.docinfo td:hover {color: #000000} */
  

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold;text-align: left;white-space: nowrap;padding-left: 0 }
  
table.docutils th
{
color: black;
font-weight:normal;
background-color: #E3E3E3;
border-top: 1px solid #1d1d1d;
border-bottom: 1px solid #1d1d1d;
}
  
h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {font-size: 100% }
ul.auto-toc { list-style-type: none }
/*a.reference { color: #E00000; font-weight:bold;}
a.reference:hover {color: #E00000;background-color: #ffff00;display: margin;
  font-weight:bold;}*/

</style>

</head>
<body>
<div class="document" id="documentId">
<h1 class="title">Nimrod Ouroboros appended data file format</h1>
<p>A normal binary is read from the beginning and trailing bytes are discarded by the operating system. What follows is the payload plus an informative <em>footer</em> (the inverse of a file header). Tools or programs willing to detect if a binary contains appended data have to open the binary and read the last few bytes of the footer.</p>
<ul class="simple"><li>Binary data</li>
<li>Payload data</li>
<li>Footer meta data</li>
</ul>

<h1 id="footer-format">Footer format</h1><p>The footer length is always 9 bytes long. If you position the stream at the end of the file size minus 9 bytes, you should read a 4 bytes magic marker, a format/version byte, and 4 bytes length value:</p>
<ol class="simple"><li>0xF3</li>
<li>0x6C</li>
<li>0x68</li>
<li>0xFB</li>
<li>Payload format/version</li>
<li>Payload length fragment (MSB)</li>
<li>Payload length fragment</li>
<li>Payload length fragment</li>
<li>Payload length fragment (LSB)</li>
</ol>
<p>Note that the footer can't have a payload length of negative or zero value. This translates into a maximum payload length of 2GiB. If a payload is zero or negative you should consider the file corrupt or without appended data.</p>
<p>The payload length is stored in Motorola byte ordering (big endian), where the first byte contains the most significant byte of the value.</p>

<h1 id="payload-format">Payload format</h1><p>The payload format allows different formats and expansion for the future.</p>

<h2 id="payload-format-0x00-unsupported">Payload format 0x00, unsupported</h2><p>This value will never be present in any file. If a reader of appended data reads an unknown file format, it should be treated as zero, meaning the reader won't be able to handle the payload and operations on the binary should be avoided.</p>

<h2 id="payload-format-0x01-raw-blob">Payload format 0x01, raw BLOB</h2><p>This value means that the payload is treated as a single large binary object. It is the most simple way of handling data, but it is usually limited to retrieving the whole binary data at once.</p>

<h2 id="payload-format-0x02-indexed-format">Payload format 0x02, indexed format</h2><p>This format is used for appending several files to the binary. The files' contents are concatenated and put after an index. The index contains the original filename paths and sizes to recover the correct pieces:<pre>
payload = index packets + file1 content +
    ... + fileN content</pre>
</p>
<p>The <em>index packets</em> are just a sequence of <em>commands</em> which build up in memory the original file paths of the payload. A reader should parse completely all index packets in one go and keep in memory the tree they generate to know where each file starts/ends. The packets create in memory a read only replica of a virtual file system structure with its own directories and filenames. When you start to read the information think of an empty file system at the root (<tt class="docutils literal"><span class="pre">/</span></tt>).  Packets are found one after another, with the first byte indicating the type of content following it.</p>
<p>There is not much point in forward compatibility, so if you find an unknown packet type just abort and give up parsing the file.</p>

<h3 id="index-packet-0x00-end-of-index">Index packet 0x00, end of index</h3><p>If a packet header is zero it means there are no more packets to process.</p>

<h3 id="index-packet-0x01-directory-prefix">Index packet 0x01, directory prefix</h3><p>This packet means that the current virtual file system has to change to another directory. A single bytes will specify the length in bytes of the absolute path filename, which will be used for the following files. All directory prefix packets are required to have a length of 1, because all paths have to start with a starting slash. The path can optionally have a trailing slash.</p>
<p>On disk the official path separator is the forward slash <tt class="docutils literal"><span class="pre">/</span></tt> but paths read into memory should be filtered through the os.UnixToNativePath proc for end user code. Paths are case sensitive. Path components like <tt class="docutils literal"><span class="pre">.</span></tt> or <tt class="docutils literal"><span class="pre">..</span></tt> <strong>will not</strong> be resolved. The encoding of the paths is UTF8.  Examples:</p>
<ul class="simple"><li>Byte length 6, string value <tt class="docutils literal"><span class="pre">/home/</span></tt></li>
<li>Byte length 16, string value <tt class="docutils literal"><span class="pre">/españa/level01</span></tt></li>
<li>Byte length 18, string value <tt class="docutils literal"><span class="pre">/gallery/티아라</span></tt></li>
<li>Byte length 1, string value <tt class="docutils literal"><span class="pre">/</span></tt></li>
</ul>
<p>It is perfectly valid to alternate between directories between packets going back and forth, though that's a little bit wasteful.</p>

<h3 id="index-packet-0x02-long-directory-prefix">Index packet 0x02, long directory prefix</h3><p>The format of this packet is exactly the same as 0x01 except that the length byte is replaced with two bytes in Motorola byte ordering (big endian) to specify the length in bytes of the absolute path filename.</p>
<p>The two byte directory prefix is separate because most of the time path prefixes will likely fit into a single byte.</p>

<h3 id="index-packet-0x03-file">Index packet 0x03, file</h3><p>This packet means that a file will be <em>placed</em> at the current filesystem virtual path previously specified through directory packets. If no directory packets have been specified, files are to be placed at the root of the virtual filesystem. This packet has the format:<pre>
packet = filename length + filename +
    offset + length</pre>
</p>
<p>The filename length is stored in a single byte, and it contains the length in bytes of the UTF filename. Both the offset and length are specified as four bytes in Motorola byte ordering (big endian). The offset is measured as the number of bytes since the beginning of the appended data. It is therefore impossible to have an offset smaller than a few bytes since the index of filenames contributes to it.</p>

<h3 id="index-packet-0x04-long-name-file">Index packet 0x04, long name file</h3><p>The format of this packet is exactly the same as 0x03 except that the length byte is replaced with two bytes in Motorola byte ordering (big endian) to specify the length in bytes of the filename.</p>
<p>The two byte directory prefix is separate because most of the time filenames will likely fit into a single byte. </p>



<small>Generated: 2014-05-31 21:19:51 UTC</small>
</div>
</body>
</html>
